# 2026년 2월 27일

## [종합 보고] 동기식 서비스 완성부터 병렬 Saga 아키텍처 구축까지

오늘의 작업은 주문 마이크로서비스의 핵심 비즈니스 로직을 동기식에서 비동기(Saga 패턴)로, 그리고 다시 고성능 병렬 구조로 고도화하는 전 과정을 다루었습니다.

### 🚀 핵심 성과: 병렬적 코레오그래피(Parallel Choreography) Saga 완성
- **성능 최적화:** 재고 차감과 적립금 차감을 동시에 실행하여 응답 속도를 개선했습니다.
- **상태 취합(Join) 매커니즘:** `Order` 엔티티 내에 각 서비스 성공 플래그를 두고, 모든 조건 충족 시 최종 `COMPLETED`로 전이되는 로직을 구현했습니다.
- **데이터 정합성:** 비동기 환경에서도 `@TransactionalEventListener`와 `REQUIRES_NEW`를 조합하여 안전하게 트랜잭션을 관리했습니다.

---

### 🛠 상세 작업 이력

#### [Phase 3] 병렬 구조 고도화 및 트러블슈팅
- **도메인 확장:** `Order` 엔티티 필드 추가 (`isStockDeducted`, `isPointDeducted`).
- **이벤트 리팩토링:** `PointEventListener`가 `OrderCreatedEvent`를 직접 구독하도록 수정.
- **DB 이슈 해결:** 신규 컬럼 반영을 위해 테이블 드랍 후 재생성(`ddl-auto: create`) 수행.
- **테스트:** 병렬 환경에서의 성공 및 실패(`CANCELLED`) 시나리오 통합 테스트 완료.

#### [Phase 2] 비동기 코레오그래피 Saga (순차) 구현
- **이벤트 정의:** `OrderCreatedEvent` 등 5종의 비즈니스 이벤트 정의.
- **트랜잭션 격리 해결:** 주문 생성 commit 전 조회 에러를 해결하기 위해 `AFTER_COMMIT` 단계의 리스너 적용.
- **가시성 확보:** 실패한 주문이 롤백되어 사라지지 않고 `CANCELLED` 상태로 보존되도록 개선.

#### [Phase 1] 동기식 서비스 완성 및 클린 코드 리팩토링
- **기본 기능:** 재고/적립금 포트 및 어댑터 구현, 주문 생성 로직 통합.
- **기술 부채 청산:** `orders` 예약어 충돌 문제를 테이블 명 변경(`eda_order`)으로 해결.
- **Senior-Level 리팩토링:**
  - 정적 팩토리 메서드 및 도메인 내부 검증 로직 도입.
  - Bean Validation을 통한 API 입력값 무결성 확보.

---

### 💡 기술적 고찰 (Deep Dive)
1. **Saga 설계 전략:** 순차 구조의 안전함과 병렬 구조의 성능 사이의 트레이드-오프를 분석하고, 비즈니스 성격에 따른 선택 기준 수립.
2. **신뢰할 수 있는 메시징:** 현재 방식의 '이벤트 유실 위험'을 인지하고, 향후 **Transactional Outbox Pattern** 도입의 필요성 확인.
3. **낙관적 락의 필요성:** 병렬 처리 시 발생할 수 있는 Race Condition 방지를 위해 차기 리팩토링 과제로 `@Version` 도입 선정.

---

### 📅 향후 계획
- **3단계 Kafka 도입:** Spring 내부 이벤트를 외부 메시지 브로커로 전환하여 실제 분산 시스템 구축.
- **4단계 보상 트랜잭션 완성:** 실패 시 성공한 서비스의 자원을 원상복구(Restore)하는 로직 추가.
- **5단계 Observability:** 분산 트랜잭션 추적 및 모니터링 환경 구축.
