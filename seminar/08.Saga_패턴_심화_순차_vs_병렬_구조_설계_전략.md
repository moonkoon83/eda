# 08. Saga 패턴 심화: 순차(Sequential) vs 병렬(Parallel) 구조 설계 전략

비동기 이벤트 기반 아키텍처(EDA)에서 Saga 패턴을 구현할 때 가장 중요한 결정 중 하나는 **"각 단계의 실행 순서를 어떻게 제어할 것인가"**입니다. 본 자료는 순차적 흐름과 병렬적 흐름의 차이를 분석하고 상황별 최적의 선택 기준을 제시합니다.

## 1. 순차적(Sequential) 코레오그래피
우리가 현재 주문 서비스에 적용한 방식입니다. 하나의 서비스가 성공하면 다음 서비스의 바톤(이벤트)을 넘겨주는 방식입니다.

### 🏃‍♂️ 흐름 (Chaining)
`OrderCreated` → **[Stock]** → `StockDeducted` → **[Point]** → `PointDeducted` → **[Order Complete]**

- **특징:** 서비스 간 인과관계가 명확합니다. (예: 재고가 있어야 결제 가능)
- **장점:** 
    - **단순함:** 로직의 흐름이 직관적이며 추적하기 쉽습니다.
    - **보상 트랜잭션의 명확성:** 실패 시 바로 이전 단계로 돌아가 취소 작업을 수행하는 흐름이 단순합니다.
- **단점:** 
    - **지연 시간(Latency):** 각 서비스 처리 시간의 총합이 전체 주문 시간이 됩니다.
    - **긴 체인:** 서비스가 많아질수록 이벤트 체인이 길어져 관리가 복잡해질 수 있습니다.

## 2. 병렬적(Parallel) 코레오그래피
모든 하위 서비스가 첫 번째 이벤트를 수신하자마자 동시에 작업을 시작하는 방식입니다.

### ⚡ 흐름 (Broadcasting)
`OrderCreated` ──┬─→ **[Stock]** ─→ `StockDeducted` ──┐
                 └─→ **[Point]** ─→ `PointDeducted` ──┴─→ **[Order Complete (Wait All)]**

- **특징:** 각 서비스는 서로의 존재를 모른 채 병렬로 실행됩니다.
- **장점:** 
    - **성능 극대화:** 전체 처리 시간은 참여 서비스 중 가장 오래 걸리는 서비스의 시간과 같습니다.
    - **독립성:** 서비스 간 선후 관계가 없을 때 최상의 확장성을 제공합니다.
- **단점:** 
    - **취합 로직(Join):** `OrderEventListener`가 "재고 성공"과 "포인트 성공" 소식을 **모두** 받았는지 체크하는 복잡한 상태 관리(Stateful) 로직이 필요합니다.
    - **복잡한 보상 트랜잭션:** 재고는 성공했는데 포인트는 실패했다면? 포인트 실패 이벤트를 재고 서비스도 구독하여 보상 작업을 수행해야 합니다.

## 3. 설계 선택 기준 (Decision Matrix)

| 기준 | 순차적 (Sequential) | 병렬적 (Parallel) |
| :--- | :--- | :--- |
| **비즈니스 종속성** | 앞 단계 결과가 뒷 단계에 필수적일 때 | 각 단계가 서로 독립적일 때 |
| **성능 요구사항** | 중간 정도의 응답 속도 | 초고속/대량 트랜잭션 처리 필요 시 |
| **구현 난이도** | 낮음 (직관적 체이닝) | 높음 (상태 관리 및 복잡한 보상 흐름) |
| **적합한 사례** | 주문 -> 재고 -> 결제 프로세스 | 주문 -> 알림 발송 & 데이터 분석 & 외부 연동 |

## 4. 실무 권장 전략: 하이브리드(Hybrid)

실제 마이크로서비스 환경에서는 두 방식을 섞어서 사용합니다.

1.  **Critical Path (순차):** 재고 확보와 결제처럼 **반드시 순서가 보장되어야 하는 핵심 비즈니스**는 순차적으로 엮습니다.
2.  **Side Effects (병렬):** 결제 성공 후 발생하는 **알림톡 발송, 포인트 적립, 통계 데이터 전송** 등은 동시에 병렬로 처리하여 고객 응답 속도를 높입니다.

## 5. 결론

Saga 패턴 설계 시 처음부터 병렬 구조를 고민하기보다, **가장 안전하고 단순한 순차 구조로 시작**하는 것이 좋습니다. 이후 시스템의 성능 병목이 발생하거나 서비스 간 독립성이 명확해지는 시점에 병렬 구조나 **오케스트레이터(Orchestrator)** 도입을 검토하는 것이 senior 엔지니어의 올바른 접근 방식입니다.
